<!DOCTYPE html>
<html>

<head>
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style/style.css') }}">
    <script src="https://github.com/op-en/animera.js/releases/download/v2.2.0/animera.js" data-autobind="https://op-en.se"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='animera.js-master/dist/AnimeraWidget.js') }}"></script>
</head>

<script>
    setInterval(function() {
        var request = new XMLHttpRequest();
        request.open('GET', '/api/query');
        request.onreadystatechange = function() {
            if (request.readyState === 4) {
                if (request.responseText !== 'none') {
                    var positionleft1 = document.getElementById("spaceship1").offsetLeft;
                    var positiontop1 = document.getElementById("spaceship1").offsetTop;
                    var positionleft2 = document.getElementById("spaceship2").offsetLeft;
                    var positiontop2 = document.getElementById("spaceship2").offsetTop;
                    window.location.href = '/page2?person=' + request.responseText + '?left1='+positionleft1 + '?top1=' + positiontop1 + '?left2='+positionleft2 + '?top2=' + positiontop2;
                }
            }
        };
        request.send();
    }, 1000);

    function getURLParameter(variable)
    {
       var query = window.location.search.substring(1);
       var vars = query.split("?");
       for (var i=0;i<vars.length;i++) {
           var pair = vars[i].split("=");
           if(pair[0] == variable){return pair[1];}
       }
       return(false);
   }

</script>

<body>

    <img src="{{ url_for('static', filename='img/earth.png') }}" style="width: 40%; position: absolute; top: 60%;left: 75%">
    <img src="{{ url_for('static', filename='img/planet1.png') }}" style="width: 10%; position: absolute; top: 40%;left: 45%">
    <img src="{{ url_for('static', filename='img/planet2.2.png') }}" style="width: 20%; position: absolute; top: 0%;left: 0%">
    <p id="value">number</p>
    <p id="value2">number</p>

    <div id="spaceship1">
        <div id="fan" animera="bindTopicToRotation?inputRange=[0,2500];outputRange=[0,0.5];relative=true;clamp=true;topic=test/roy/group/1;subproperty=saving"></div>
    </div>

    <div id="spaceship2">
        <div id="fan" animera="bindTopicToRotation?inputRange=[0,2500];outputRange=[0,0.5];relative=true;clamp=true;topic=test/roy/group/2;subproperty=saving"></div>
    </div>

    <script>

        var url = location.search;
        if (url.indexOf('?')!=-1) {
            myleft1 = getURLParameter('left1');
            mytop1 = getURLParameter('top1');
            myleft2 = getURLParameter('left2');
            mytop2 = getURLParameter('top2');
            document.getElementById("spaceship1").style.left=Number(myleft1)+'px';
            document.getElementById("spaceship1").style.top=Number(mytop1) + 'px';
            document.getElementById("spaceship2").style.left=Number(myleft2)+'px';
            document.getElementById("spaceship2").style.top=Number(mytop2) + 'px';
        }
    
        AnimeraWidget.init({
            server: 'https://op-en.se',
            topic: 'test/roy/group/1',
            subproperty: "saving",
            outputRange: [0.1, 10]
        }).then(function (objects) {
            var settings = objects.settings;
            var controller = objects.animera.getController(settings.server)
            controller.bindTopicToHtml(document.getElementById("value"), settings)
            controller.bindTopicToCallback(function(data){
                var ship = document.getElementById("spaceship1");
                var baseline = 200;
                var movement = 1;
                if (data <0){
                    function move(){
                        var positionleft = document.getElementById("spaceship1").offsetLeft;
                        var positiontop = document.getElementById("spaceship1").offsetTop;
                        ship.style.left=(positionleft-movement) + 'px';
                        ship.style.top=(positiontop-movement)+'px';
                    };
                    movetime = (data / baseline) * 5;

                    setInterval(move,movetime);
                }else{

                }
                
            },settings)

        })

        AnimeraWidget.init({
            server: 'https://op-en.se',
            topic: 'test/roy/group/2',
            subproperty: "saving",
            outputRange: [0.1, 10]
        }).then(function (objects) {
            var settings = objects.settings;
            var controller = objects.animera.getController(settings.server)
            controller.bindTopicToHtml(document.getElementById("value2"), settings)
            controller.bindTopicToCallback(function(data){
                var ship = document.getElementById("spaceship2");
                var movement = 1;
                var baseline = 200;
                if (data >0){
                    function move(){
                        var positionleft = document.getElementById("spaceship2").offsetLeft;
                        var positiontop = document.getElementById("spaceship2").offsetTop;
                        ship.style.left=(positionleft-movement) + 'px';
                        ship.style.top=(positiontop-movement)+'px';
                    };
                    movetime = (data / baseline) * 5;
                    setInterval(move,movetime);
                }else{

                }
                
            },settings)

        })
    </script>

    
</body>


</html>